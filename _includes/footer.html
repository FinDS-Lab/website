<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FINDS Lab Footer Player</title>

    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RSGEYHWRHR"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      gtag('js', new Date());
      gtag('config', 'G-RSGEYHWRHR');
    </script>

    <style>
      /* 링크 색상 */
      #siteFooter { --link-color: rgb(172, 14, 14); }

      /* ===== 플레이어 박스 ===== */
      .music-player-box{
        width:420px;max-width:100%;
        background:#f8fafc;border:1px solid #e2e8f0;border-radius:16px;
        padding:12px 16px;box-shadow:0 1px 3px 0 rgb(0 0 0 / .1);
      }

      /* ===== 컨트롤 행 (한 줄 + 진행바 오버레이) ===== */
      .controls-row{
        position:relative;
        display:grid;
        grid-template-columns:28px 36px 28px 1fr 80px; /* 이전/재생/다음 | 제목 | 볼륨 */
        gap:8px;align-items:center;
        min-height:42px; /* 진행바가 가운데 오도록 */
      }
      .controls-row > *:not(.progress-overlay){ position:relative; z-index:2; } /* 진행바 제외 위 레이어 */

      /* 진행바 오버레이: 컨트롤 행 내부에 겹치기 */
      .progress-overlay{
        --progress-left: 116px; /* 28+36+28 + 간격(8*3) */
        --progress-right: 90px; /* 볼륨(80) + 여유 */
        position:absolute; z-index:1;
        left:var(--progress-left); right:var(--progress-right);
        top:50%; transform:translateY(-50%);
        display:grid; grid-template-columns:40px 1fr 40px; gap:8px; align-items:center;
        pointer-events:none; /* 기본적으로 클릭 불가 */
      }
      .progress-overlay > * { pointer-events:auto; } /* 자식 요소는 클릭 가능 */

      /* 버튼들 */
      .nav-btn,.play-btn{
        display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer;
        border:1px solid #e2e8f0;border-radius:50%;background:#fff;transition:all .2s;
      }
      .nav-btn{width:28px;height:28px;padding:6px;}
      .play-btn{width:36px;height:36px;padding:8px;box-shadow:0 1px 2px 0 rgb(0 0 0 / .05);}
      .nav-btn svg{width:14px;height:14px;color:#64748b;}
      .play-btn svg{width:20px;height:20px;color:#475569;}
      .nav-btn:hover,.play-btn:hover{background:#f1f5f9;transform:scale(1.05);}

      /* 제목 */
      .music-info{display:flex;align-items:center;gap:8px;overflow:hidden;min-width:0}
      .music-note-animation{flex-shrink:0}
      .music-note-animation svg{width:14px;height:14px;color:#64748b}
      .music-title{
        color:rgb(214,177,77);font-size:12px;font-weight:600;
        white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;
        text-shadow:0 1px 2px rgba(0,0,0,.1);letter-spacing:.01em;line-height:1.2;display:block;
      }
      .music-title.marquee{animation:marquee 12s linear infinite;will-change:transform}
      @keyframes marquee{
        0%,25%{transform:translateX(0)} 50%,75%{transform:translateX(calc(-100% + 160px))} 100%{transform:translateX(0)}
      }
      #musicPlayer:not(.playing) .music-title.marquee{animation:none}
      .music-title.marquee:hover{animation-play-state:paused}

      /* 볼륨 */
      .volume-controls{display:flex;align-items:center;gap:8px;width:80px;flex-shrink:0}
      .mute-btn{padding:4px;background:none;border:0;cursor:pointer}
      .mute-btn svg{width:14px;height:14px;color:#64748b}
      .volume-slider{width:50px;height:4px;background:#e2e8f0;border-radius:2px;outline:none;-webkit-appearance:none;cursor:pointer}

      /* 진행바 구성요소 */
      .time-text{font-family:monospace;font-size:11px;color:#64748b;text-align:center;width:40px}
      .progress-container{position:relative;height:4px;width:100%}
      .progress-slider{
        width:100%;height:4px;background:transparent;border-radius:2px;outline:none;
        -webkit-appearance:none;cursor:pointer;position:relative;z-index:3;
      }
      /* 진행바 배경 트랙 */
      .progress-track{
        position:absolute;top:50%;transform:translateY(-50%);left:0;right:0;height:4px;
        background:#e2e8f0;border-radius:2px;pointer-events:none;z-index:1;
      }
      /* 진행바 채워진 부분 */
      .progress-fill{
        position:absolute;top:50%;transform:translateY(-50%);left:0;height:4px;
        background:#94a3b8;border-radius:2px;pointer-events:none;transition:width .1s;z-index:2;width:0%;
      }
      
      /* 슬라이더 썸 스타일 */
      .volume-slider::-webkit-slider-thumb,
      .progress-slider::-webkit-slider-thumb{
        -webkit-appearance:none;appearance:none;
        width:12px;height:12px;background:#475569;border-radius:50%;cursor:pointer;position:relative;z-index:4;
      }
      .volume-slider::-moz-range-thumb,
      .progress-slider::-moz-range-thumb{
        width:12px;height:12px;background:#475569;border-radius:50%;cursor:pointer;position:relative;z-index:4;border:none;
      }
      
      /* 슬라이더 트랙 투명화 (배경은 별도 div로 처리) */
      .progress-slider::-webkit-slider-runnable-track{
        background:transparent;height:4px;
      }
      .progress-slider::-moz-range-track{
        background:transparent;height:4px;
      }

      /* 링크/애니메이션/기타 */
      @keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
      .music-note-animation svg{animation:musicBounce 2s ease-in-out infinite}
      @keyframes musicBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-2px)}}
      #musicPlayer.playing .music-note-animation svg{animation:musicPulse 1s ease-in-out infinite}
      @keyframes musicPulse{0%,100%{transform:scale(1);opacity:.7}50%{transform:scale(1.2);opacity:1}}

      .link-underline{position:relative;color:var(--link-color);transition:color .2s}
      .link-underline::after{content:"";position:absolute;left:0;bottom:-2px;width:100%;height:2px;background:var(--link-color);transform:scaleX(0);transform-origin:left;transition:transform .2s}
      .link-underline:hover::after{transform:scaleX(1)}

      #btnTop{opacity:0;transform:translateY(6px);transition:all .2s;z-index:40}
      #btnTop.is-visible{opacity:1;transform:translateY(0)}

      #visitor-counter{opacity:0;animation:fadeInUp .6s ease forwards;animation-delay:.2s}
      @keyframes fadeInUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
      .counter-animate{display:inline-block;animation:counterPulse .3s ease}
      @keyframes counterPulse{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}

      /* 2x2 레이아웃 */
      .footer-grid{
        display:grid;grid-template-columns:1fr 1fr;grid-auto-rows:auto;gap:2rem;align-items:start;max-width:900px;margin:0 auto;
      }
      /* 저작권: 2행 전체 + 가운데 */
      .copyright-row{grid-column:1 / -1;text-align:center;margin:0 auto}

      .right-section{display:flex;flex-direction:column;gap:1rem;align-items:center;justify-content:center;height:100%}

      /* 다크모드 */
      @media (prefers-color-scheme:dark){
        footer.bg-white{background:#0b0f19}
        footer .text-slate-500{color:#cbd5e1}
        footer .text-slate-400{color:#94a3b8}
        footer .text-slate-700{color:#e2e8f0}
        #btnTop{background:rgba(15,23,42,.85);border-color:#334155}
        #btnTop svg{color:#e2e8f0}
        .music-player-box{background:rgba(30,41,59,.8);border-color:#334155}
        .nav-btn,.play-btn{background:rgba(51,65,85,.8);border-color:#475569}
        .nav-btn:hover,.play-btn:hover{background:rgba(71,85,105,.8)}
        .music-title{color:rgb(214,177,77)}
        .progress-track{background:rgba(71,85,105,.6)}
        .progress-fill{background:#94a3b8}
        .progress-slider::-webkit-slider-thumb,
        .progress-slider::-moz-range-thumb{background:#cbd5e1}
        .volume-slider{background:rgba(71,85,105,.6)}
        .volume-slider::-webkit-slider-thumb,
        .volume-slider::-moz-range-thumb{background:#cbd5e1}
      }

      /* 모바일 최적화 */
      @media (max-width:768px){
        .footer-grid{grid-template-columns:1fr;gap:1.5rem}
        .music-player-box{width:100%;max-width:480px;margin:0 auto;padding:10px 12px}
        .controls-row{grid-template-columns:28px 36px 28px 1fr 72px}
        .progress-overlay{--progress-left:110px;--progress-right:80px}
        .music-title{font-size:11px}
        .time-text{font-size:10px}
        .text-sm{font-size:.813rem}.text-xs{font-size:.688rem}
      }
      @media (max-width:440px){
        .music-player-box{width:calc(100vw - 24px);min-width:300px;padding:8px 10px}
        .controls-row{grid-template-columns:24px 30px 24px 1fr 60px;gap:6px}
        .progress-overlay{--progress-left:96px;--progress-right:66px}
        .nav-btn{width:24px;height:24px;padding:5px}.nav-btn svg{width:12px;height:12px}
        .play-btn{width:30px;height:30px;padding:6px}.play-btn svg{width:16px;height:16px}
        .volume-controls{width:60px;gap:4px}.volume-slider{width:35px}
        .time-text{font-size:9px;width:35px}
        .music-title{font-size:10px}
      }
      @media (max-width:360px){
        .music-player-box{width:calc(100vw - 20px);min-width:280px;padding:6px 8px}
        .controls-row{grid-template-columns:22px 28px 22px 1fr 55px;gap:4px}
        .progress-overlay{--progress-left:88px;--progress-right:60px}
        .nav-btn{width:22px;height:22px;padding:4px}
        .play-btn{width:28px;height:28px;padding:5px}
        .volume-controls{width:55px}.volume-slider{width:30px}
        .music-title{font-size:9px}
        .time-text{font-size:9px;width:32px}
        .text-sm{font-size:.75rem}.text-xs{font-size:.625rem}
      }

      .error-message{color:#ef4444;font-size:12px;text-align:center;padding:8px}
    </style>
  </head>
  <body>

    <!-- (원한다면 여기에 메인 콘텐츠) -->

    <footer class="mt-16 border-t border-slate-200 bg-white" aria-label="Site footer" id="siteFooter">
      <div class="max-w-7xl mx-auto px-4 py-10">
        <div class="footer-grid">

          <!-- 플레이어 -->
          <div id="musicPlayer" style="opacity:0;animation:fadeIn .5s ease forwards;">
            <div class="music-player-box" role="group" aria-label="배경 음악 플레이어">

              <!-- 컨트롤 + 진행바(오버레이) 한 줄 -->
              <div class="controls-row">
                <!-- 이전 -->
                <button id="prevBtn" class="nav-btn" type="button" aria-label="이전 곡">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M8.445 14.832A1 1 0 0010 14v-2.798l5.445 3.63A1 1 0 0017 14V6a1 1 0 00-1.555-.832L10 8.798V6a1 1 0 00-1.555-.832l-6 4a1 1 0 000 1.664l6 4z"/></svg>
                </button>

                <!-- 재생/일시정지 -->
                <button id="playPauseBtn" class="play-btn" type="button" aria-label="재생/일시정지">
                  <svg id="playIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/></svg>
                  <svg id="pauseIcon" class="hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
                </button>

                <!-- 다음 -->
                <button id="nextBtn" class="nav-btn" type="button" aria-label="다음 곡">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M4.555 5.168A1 1 0 003 6v8a1 1 0 001.555.832L10 11.202V14a1 1 0 001.555.832l6-4a1 1 0 000-1.664l-6-4A1 1 0 0010 6v2.798L4.555 5.168z"/></svg>
                </button>

                <!-- 제목 -->
                <div class="music-info" aria-live="polite">
                  <div class="music-note-animation" aria-hidden="true">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M18 3a1 1 0 00-1.196-.98l-10 2A1 1 0 006 5v9.114A4.369 4.369 0 005 14c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V7.82l8-1.6v5.894A4.37 4.37 0 0015 12c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V3z"/></svg>
                  </div>
                  <span id="musicTitle" class="music-title" title="Background Music">Loading playlist...</span>
                </div>

                <!-- 볼륨 -->
                <div class="volume-controls">
                  <button id="muteBtn" class="mute-btn" type="button" aria-label="음소거 토글">
                    <svg id="volumeIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z" clip-rule="evenodd"/></svg>
                    <svg id="muteIcon" class="hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM12.293 7.293a1 1 0 011.414 0L15 8.586l1.293-1.293a1 1 0 111.414 1.414L16.414 10l1.293 1.293a1 1 0 01-1.414 1.414L15 11.414l-1.293 1.293a1 1 0 01-1.414-1.414L13.586 10l-1.293-1.293a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                  </button>
                  <input type="range" id="volumeSlider" min="0" max="100" value="30" class="volume-slider" aria-label="볼륨 조절">
                </div>

                <!-- 진행바: 컨트롤 행 위에 겹치기 -->
                <div class="progress-overlay" aria-label="재생 진행도">
                  <span id="currentTime" class="time-text">0:00</span>
                  <div class="progress-container">
                    <div class="progress-track"></div>
                    <div id="progressBar" class="progress-fill"></div>
                    <input type="range" id="progressSlider" min="0" max="100" value="0" step="0.1" class="progress-slider" aria-label="재생 위치 이동">
                  </div>
                  <span id="duration" class="time-text">0:00</span>
                </div>
              </div>
            </div>
          </div>

          <!-- 링크 + 카운터 -->
          <div class="right-section">
            <p class="text-center text-sm text-slate-500 font-semibold">
              <a class="link-underline" href="https://scholar.google.com/" target="_blank" rel="noopener">Google Scholar</a>
              <span class="mx-2 text-slate-300">|</span>
              <a class="link-underline" href="https://www.nrf.re.kr/" target="_blank" rel="noopener">한국연구재단</a>
            </p>
            <div id="visitor-counter" class="flex items-center gap-4" role="status" aria-live="polite">
              <div class="flex items-center gap-2 text-xs text-slate-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/></svg>
                <span>오늘 방문</span><span id="todayCount" class="font-mono font-semibold text-slate-700">0</span>
              </div>
              <div class="flex items-center gap-2 text-xs text-slate-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 1 1 0 000 2H6a2 2 0 100 4h2a2 2 0 100-4h-.5a1 1 0 000-2H8a2 2 0 012-2h2a2 2 0 012 2v9a2 2 0 01-2 2H6a2 2 0 01-2-2V5z" clip-rule="evenodd"/></svg>
                <span>전체 방문</span><span id="totalCount" class="font-mono font-semibold text-slate-700">0</span>
              </div>
            </div>
          </div>

          <!-- 2행: 저작권 (가운데) -->
          <p id="copyright" class="copyright-row text-xs text-slate-400">
            Copyright © <span id="year"></span> FINDS Lab. All Rights Reserved.
          </p>
        </div>
      </div>

      <button id="btnTop" class="fixed bottom-5 right-5 hidden rounded-full border border-slate-300 bg-white/90 backdrop-blur p-3 shadow-md hover:shadow-lg focus:outline-none" aria-label="Back to top" title="Back to top" type="button">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg>
      </button>
    </footer>

    <!-- YouTube IFrame API 대상 -->
    <div id="youtube-player" style="display:none;"></div>

    <script>
      // ===================== 전역 상태 =====================
      var YOUTUBE_CONFIG={shuffle:true};
      var tracks=[],videoIds=[];
      var orderPool=[],shuffledOrder=[],orderPos=0,currentVideoIndex=0;
      var player,isPlayerReady=false,updateTimer=null,isDragging=false,playlistLoadError=false;

      // ===================== 유틸 =====================
      function extractVideoId(url){
        if(!url)return null;if(/^[a-zA-Z0-9_-]{11}$/.test(url))return url;
        var id=null;
        if(url.includes('music.youtube.com')){var m=url.match(/[?&]v=([a-zA-Z0-9_-]{11})/);if(m)id=m[1];}
        else if(url.indexOf('v=')>-1){var v=url.split('v=')[1];if(v)id=v.split(/[&#]/)[0];}
        else if(url.indexOf('youtu.be/')>-1){id=url.split('youtu.be/')[1].split(/[?#&]/)[0];}
        else if(url.indexOf('/embed/')>-1){id=url.split('/embed/')[1].split(/[?#&]/)[0];}
        return (id && /^[a-zA-Z0-9_-]{11}$/.test(id))?id:null;
      }
      function toNumberOrNull(v){var n=parseFloat(v);return Number.isFinite(n)?n:null;}
      function collapseSpaces(s){return (s||'').replace(/\s+/g,' ').trim();}
      function forceSingleLine(text){return collapseSpaces(String(text||'').replace(/[\r\n]+/g,' '));}

      // ===================== playlist.json 로드 =====================
      function loadPlaylistJson(){
        var base=window.location.pathname.substring(0,window.location.pathname.lastIndexOf('/'));
        var url=base+'/assets/playlist.json';
        return fetch(url+'?t='+Date.now())
          .then(r=>{if(!r.ok)throw new Error('HTTP '+r.status);return r.json();})
          .then(buildFromJson).catch(()=>handlePlaylistError());
      }
      function handlePlaylistError(){
        playlistLoadError=true;
        var t=document.getElementById('musicTitle');t.textContent='Playlist 로드 실패';t.classList.add('error-message');
        ['playPauseBtn','prevBtn','nextBtn'].forEach(id=>{var b=document.getElementById(id);if(b)b.disabled=true;});
      }
      function buildFromJson(json){
        tracks=[];YOUTUBE_CONFIG.shuffle=(typeof json.shuffle==='boolean')?json.shuffle:true;
        if(!json.items||!Array.isArray(json.items)){handlePlaylistError();return;}
        json.items.forEach(item=>{
          if(item.enabled===false)return;
          var id=item.id||extractVideoId(item.url); if(!id)return;
          tracks.push({id, url:item.url||null, weight:Math.max(1,parseInt(item.weight||1,10)),
            start_at:toNumberOrNull(item.start_at), end_at:toNumberOrNull(item.end_at),
            title_override:item.title_override||null});
        });
        if(!tracks.length){handlePlaylistError();return;}
        finalizeTrackSetup();
      }
      function finalizeTrackSetup(){
        var seen={};videoIds=[];
        tracks.forEach(t=>{if(!seen[t.id]){videoIds.push(t.id);seen[t.id]=true;}});
        orderPool=[];tracks.forEach((t,i)=>{for(var k=0;k<Math.max(1,parseInt(t.weight||1,10));k++)orderPool.push(i);});
        generateShuffleOrder(); injectYouTubeAPI();
      }
      function generateShuffleOrder(){
        shuffledOrder=orderPool.slice();
        for(var i=shuffledOrder.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var tmp=shuffledOrder[i];shuffledOrder[i]=shuffledOrder[j];shuffledOrder[j]=tmp;}
        orderPos=0; currentVideoIndex=shuffledOrder[orderPos]||0;
      }

      // ===================== YouTube IFrame API =====================
      function injectYouTubeAPI(){
        if(playlistLoadError)return;
        var tag=document.createElement('script');tag.src="https://www.youtube.com/iframe_api";
        var first=document.getElementsByTagName('script')[0];first.parentNode.insertBefore(tag,first);
      }
      function onYouTubeIframeAPIReady(){
        if(!tracks.length){handlePlaylistError();return;}
        player=new YT.Player('youtube-player',{height:'0',width:'0',videoId:tracks[currentVideoIndex].id,
          playerVars:{autoplay:0,controls:0,disablekb:1,fs:0,modestbranding:1,rel:0},
          events:{onReady:onPlayerReady,onStateChange:onPlayerStateChange,onError:onPlayerError}});
      } window.onYouTubeIframeAPIReady=onYouTubeIframeAPIReady;

      function onPlayerReady(e){
        isPlayerReady=true; e.target.setVolume(30); e.target.mute(); updateVideoTitle();
        var t=tracks[currentVideoIndex]; if(t&&t.start_at!==null&&t.start_at>0){try{e.target.seekTo(t.start_at,true);}catch(_){}}}
      function onPlayerStateChange(e){
        var mp=document.getElementById('musicPlayer'), playI=document.getElementById('playIcon'), pauseI=document.getElementById('pauseIcon');
        if(e.data==YT.PlayerState.PLAYING){
          mp.classList.add('playing'); playI.classList.add('hidden'); pauseI.classList.remove('hidden'); updateVideoTitle(); startProgressUpdate();
          var t=tracks[currentVideoIndex]; if(t&&t.end_at!==null&&t.end_at>0){var remain=(t.end_at-player.getCurrentTime())*1000;
            if(remain>0)setTimeout(function(){if(player&&player.getPlayerState()==YT.PlayerState.PLAYING)loadNextVideo();},remain);}
        }else if(e.data==YT.PlayerState.PAUSED){
          mp.classList.remove('playing'); playI.classList.remove('hidden'); pauseI.classList.add('hidden'); stopProgressUpdate();
        }else if(e.data==YT.PlayerState.ENDED){
          mp.classList.remove('playing'); playI.classList.remove('hidden'); pauseI.classList.add('hidden'); stopProgressUpdate(); loadNextVideo();
        }else if(e.data==YT.PlayerState.CUED){
          updateVideoTitle(); resetProgress();
        }
      }
      function onPlayerError(){var el=document.getElementById('musicTitle'); if(tracks.length>1){el.textContent='오류 발생, 다음 곡 재생 중...'; setTimeout(loadNextVideo,1200);} else {el.textContent='재생 오류가 발생했습니다.';}}

      // ===================== 재생 제어 =====================
      function gotoByStep(step){
        if(tracks.length<=1)return;
        if(YOUTUBE_CONFIG.shuffle&&shuffledOrder.length>0){orderPos=(orderPos+step+shuffledOrder.length)%shuffledOrder.length; currentVideoIndex=shuffledOrder[orderPos];}
        else{currentVideoIndex=(currentVideoIndex+step+tracks.length)%tracks.length;}
      }
      function loadNextVideo(){gotoByStep(1); player.loadVideoById(tracks[currentVideoIndex].id); var t=tracks[currentVideoIndex];
        if(t&&t.start_at!==null&&t.start_at>0){setTimeout(function(){try{player.seekTo(t.start_at,true);}catch(_){}} ,250);} }
      function loadPreviousVideo(){gotoByStep(-1); player.loadVideoById(tracks[currentVideoIndex].id); var t=tracks[currentVideoIndex];
        if(t&&t.start_at!==null&&t.start_at>0){setTimeout(function(){try{player.seekTo(t.start_at,true);}catch(_){}} ,250);} }

      // ===================== 제목 표시 =====================
      function applyTitle(el,text){
        var one=forceSingleLine(text); el.textContent=one; el.title=one;
        if(one.length>32)el.classList.add('marquee'); else el.classList.remove('marquee');
      }
      function updateVideoTitle(){
        if(!isPlayerReady||!player)return;
        try{
          var vd=player.getVideoData(), el=document.getElementById('musicTitle'), t=tracks[currentVideoIndex];
          el.classList.remove('error-message');
          if(t&&t.title_override){applyTitle(el,t.title_override);return;}
          if(vd){
            var title=vd.title||'', author=vd.author||'', txt=title;
            txt=txt.replace(/\s*\([^)]*\)\s*$/,'').replace(/\s*(Official\s*(Video|Audio|MV|M\/V))?\s*$/i,'').replace(/\s*\[.*?\]\s*$/g,'').replace(/\s*【.*?】\s*$/g,'').replace(/\s*-\s*Topic\s*$/i,'');
            if(author&&!txt.includes(author)){author=author.replace(/\s*-\s*Topic\s*$/i,''); txt=txt+' - '+author;}
            if(txt.includes(' | ')){var p=txt.split(' | '); if(p.length===2)txt=p[0].trim()+' - '+p[1].trim();}
            applyTitle(el,txt);
          }
        }catch(_){document.getElementById('musicTitle').textContent='Background Music';}
      }

      // ===================== 진행 바 =====================
      function formatTime(s){if(!s||isNaN(s))return '0:00'; var m=Math.floor(s/60),sec=Math.floor(s%60); return m+':' + (sec<10?'0':'')+sec;}
      function updateProgress(){
        if(!isPlayerReady||!player||isDragging)return;
        try{var ct=player.getCurrentTime(), dur=player.getDuration();
          if(dur>0){var pct=(ct/dur)*100; document.getElementById('progressSlider').value=pct; document.getElementById('progressBar').style.width=pct+'%';
            document.getElementById('currentTime').textContent=formatTime(ct); document.getElementById('duration').textContent=formatTime(dur);}
        }catch(_){}
      }
      function startProgressUpdate(){if(!updateTimer){updateTimer=setInterval(updateProgress,500);updateProgress();}}
      function stopProgressUpdate(){if(updateTimer){clearInterval(updateTimer);updateTimer=null;}}
      function resetProgress(){document.getElementById('progressSlider').value=0;document.getElementById('progressBar').style.width='0%';document.getElementById('currentTime').textContent='0:00';document.getElementById('duration').textContent='0:00'}

      // ===================== DOM 바인딩/부가 기능 =====================
      (function(){
        document.addEventListener('DOMContentLoaded',function(){
          document.getElementById('year').textContent=new Date().getFullYear();
          loadPlaylistJson();

          // 컨트롤
          document.getElementById('playPauseBtn').addEventListener('click',function(){
            if(playlistLoadError||!isPlayerReady||!player)return;
            var s=player.getPlayerState();
            if(s==YT.PlayerState.PLAYING){player.pauseVideo();}
            else{player.playVideo(); if(player.isMuted()){player.unMute();document.getElementById('volumeIcon').classList.remove('hidden');document.getElementById('muteIcon').classList.add('hidden');}}
          });
          document.getElementById('prevBtn').addEventListener('click',function(){if(playlistLoadError||!isPlayerReady||!player||tracks.length<=1)return;loadPreviousVideo();});
          document.getElementById('nextBtn').addEventListener('click',function(){if(playlistLoadError||!isPlayerReady||!player||tracks.length<=1)return;loadNextVideo();});
          document.getElementById('muteBtn').addEventListener('click',function(){
            if(!isPlayerReady||!player)return;
            if(player.isMuted()){player.unMute();document.getElementById('volumeIcon').classList.remove('hidden');document.getElementById('muteIcon').classList.add('hidden');}
            else{player.mute();document.getElementById('volumeIcon').classList.add('hidden');document.getElementById('muteIcon').classList.remove('hidden');}
          });
          document.getElementById('volumeSlider').addEventListener('input',function(){
            if(!isPlayerReady||!player)return; player.setVolume(this.value);
            if(this.value==0){player.mute();document.getElementById('volumeIcon').classList.add('hidden');document.getElementById('muteIcon').classList.remove('hidden');}
            else if(player.isMuted()){player.unMute();document.getElementById('volumeIcon').classList.remove('hidden');document.getElementById('muteIcon').classList.add('hidden');}
          });

          // 진행바 드래그
          var slider=document.getElementById('progressSlider');
          var startDrag=function(){isDragging=true}, endDrag=function(){setTimeout(function(){isDragging=false},100)};
          slider.addEventListener('pointerdown',startDrag); slider.addEventListener('pointerup',endDrag);
          slider.addEventListener('mousedown',startDrag);   slider.addEventListener('mouseup',endDrag);
          slider.addEventListener('touchstart',startDrag,{passive:true}); slider.addEventListener('touchend',endDrag);
          slider.addEventListener('input',function(){
            document.getElementById('progressBar').style.width=this.value+'%';
            if(isPlayerReady&&player){var d=player.getDuration(); if(d>0){var t=(this.value/100)*d; document.getElementById('currentTime').textContent=formatTime(t);}}
          });
          slider.addEventListener('change',function(){
            if(!isPlayerReady||!player){isDragging=false;return;}
            var d=player.getDuration(); if(d>0){player.seekTo((this.value/100)*d,true);}
            setTimeout(function(){isDragging=false},100);
          });
        });

        // 방문자 카운터(10분 쿨다운)
        function initVisitorCounter(){
          var todayEl=document.getElementById('todayCount'), totalEl=document.getElementById('totalCount');
          var kt=new Date(new Date().toLocaleString("en-US",{timeZone:"Asia/Seoul"}));
          var today=kt.toLocaleDateString('ko-KR'); var tKey='finds_visit_'+today, totalKey='finds_visit_total', cdKey='finds_visit_cooldown';
          var last=parseInt(sessionStorage.getItem(cdKey)||'0',10), now=Date.now(), allow=(now-last)>(10*60*1000);
          if(allow){sessionStorage.setItem(cdKey,String(now)); localStorage.setItem(tKey,String((parseInt(localStorage.getItem(tKey)||'0')+1))); localStorage.setItem(totalKey,String((parseInt(localStorage.getItem(totalKey)||'0')+1))); }
          var tv=parseInt(localStorage.getItem(tKey)||'0'), tot=parseInt(localStorage.getItem(totalKey)||'0'); if(todayEl)todayEl.textContent=tv; if(totalEl)totalEl.textContent=tot;
        }
        if(window.location.hostname==='finds-lab.github.io'||window.location.hostname==='localhost'){initVisitorCounter();}

        // 상단으로
        var btn=document.getElementById('btnTop');
        window.addEventListener('scroll',function(){if(window.scrollY>240){btn.classList.add('is-visible');btn.classList.remove('hidden');}else{btn.classList.remove('is-visible');btn.classList.add('hidden');}});
        if(btn){btn.addEventListener('click',function(){window.scrollTo({top:0,behavior:'smooth'});});}
      })();
    </script>
  </body>
</html>
