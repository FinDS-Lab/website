---
layout: default
title: Archives Playlist
permalink: /archives-playlist.html
---

<!-- ===== Styles ===== -->
<style>
  /* ====== Animated Gradient Banner ====== */
  :root {
    --gold: rgb(214, 177, 77);
    --gold-mid: rgb(234, 197, 97);
    --gold-dark: rgb(194, 157, 57);
  }
  
  .banner-section {
    background: linear-gradient(135deg,
      var(--gold) 0%,
      var(--gold-mid) 25%,
      var(--gold-dark) 50%,
      var(--gold) 75%,
      var(--gold-mid) 100%);
    background-size: 400% 400%;
    animation: gradientShift 15s ease infinite;
    position: relative;
    overflow: hidden;
    min-height: 200px;
    border-radius: 1rem;
    box-shadow: 0 10px 30px rgba(0,0,0,.08);
    cursor: pointer;
  }
  
  @keyframes gradientShift {
    0% { background-position: 0% 50%;}
    50% { background-position: 100% 50%;}
    100% { background-position: 0% 50%;}
  }
  
  .banner-content {
    position: relative;
    z-index: 10;
    padding: 32px 24px;
    display: flex;
    align-items: flex-end;
    justify-content: flex-start;
    min-height: 200px;
  }
  
  .banner-breadcrumbs {
    display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;
    font-size:13px;font-weight:600;margin-bottom:8px;
  }
  .banner-breadcrumbs a{color:rgba(255,255,255,.92);text-decoration:none;transition:color .2s}
  .banner-breadcrumbs a:hover{color:#fff;text-decoration:underline}
  .banner-breadcrumbs .sep{color:rgba(255,255,255,.75)}
  .banner-breadcrumbs span:not(.sep):not(a){color:#fff;font-weight:700}
  
  .banner-title {
    font-size: 2.5rem;
    font-weight: 900;
    color: #fff;
    text-shadow: 0 2px 4px rgba(0,0,0,.12);
    letter-spacing: -0.02em;
    margin: 0;
  }

  /* Network burst particles */
  .network-burst {
    position:absolute;width:200px;height:200px;pointer-events:none;opacity:0;
    animation: burstAnimation 2s ease-out forwards;
  }
  @keyframes burstAnimation {
    0% {opacity:0;transform:scale(.3) rotate(0deg)}
    30% {opacity:.85}
    100% {opacity:0;transform:scale(2) rotate(180deg)}
  }
  .network-burst svg{width:100%;height:100%}
  .burst-line{stroke:rgba(255,255,255,.7);stroke-width:1.5;fill:none}
  .burst-dot{fill:rgba(255,255,255,.95)}

  /* ===== Collapsible Sections ===== */
  .playlist-container {
    max-width: 1280px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  .collapsible-section {
    margin-top: 1.5rem;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 1rem;
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .collapsible-header {
    padding: 1rem 1.5rem;
    background: linear-gradient(135deg, rgba(214, 177, 77, 0.08), rgba(234, 197, 97, 0.12));
    border-bottom: 1px solid rgba(214, 177, 77, 0.2);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: all 0.2s;
  }

  .collapsible-header:hover {
    background: linear-gradient(135deg, rgba(214, 177, 77, 0.12), rgba(234, 197, 97, 0.16));
  }

  .collapsible-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: rgb(214, 177, 77);
    margin: 0;
  }
  
  .collapsible-title .name-highlight {
    color: rgb(184, 137, 47);
    font-weight: 800;
  }

  .collapse-icon {
    width: 24px;
    height: 24px;
    color: rgb(214, 177, 77);
    transition: transform 0.3s ease;
  }

  .collapsible-section.open .collapse-icon {
    transform: rotate(180deg);
  }

  .collapsible-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }

  .collapsible-section.open .collapsible-content {
    max-height: 2000px;
  }

  .content-inner {
    padding: 24px;
  }

  /* ===== Music Player ===== */
  .music-player-box {
    width: 100%;
    background: #ffffff;
    border: 2px solid rgb(214, 177, 77);
    border-radius: 20px;
    padding: 24px 20px;
    box-shadow: 0 3px 15px rgba(214, 177, 77, 0.15);
  }

  .player-row {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    margin-bottom: 14px;
  }
  
  .player-row:last-child {
    margin-bottom: 0;
  }

  .playback-row { gap: 10px; }
  .volume-row { gap: 10px; }
  .artist-row { padding: 6px 0; }
  .title-row { padding: 6px 0; }
  .progress-row { gap: 12px; }
  
  #musicArtist {
    font-size: 13px;
    font-weight: 700;
    color: #B8892F;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: normal;  /* nowrap 대신 normal로 변경 */
    text-align: center;   /* 중앙 정렬 */
    line-height: 1.4;     /* 줄 간격 추가 */
  }
  
  #musicTitle {
    font-size: 16px;
    font-weight: 600;
    color: rgba(214, 177, 77, 0.85);
    white-space: normal;  /* nowrap 대신 normal로 변경 */
    text-align: center;   /* 중앙 정렬 */
    line-height: 1.4;     /* 줄 간격 추가 */
    max-width: 100%;
  }

  /* Time Display */
  .time-text {
    font-family: 'SF Mono', 'Roboto Mono', 'Monaco', 'Consolas', monospace;
    font-size: 12px;
    font-weight: 500;
    color: #6b7280;
    min-width: 45px;
    padding: 4px 8px;
    background: rgba(214, 177, 77, 0.08);
    border: 1px solid rgba(214, 177, 77, 0.2);
    border-radius: 8px;
    text-align: center;
    flex-shrink: 0;
    transition: all 0.2s ease;
    letter-spacing: 0.5px;
  }
  
  #currentTime {
    color: rgb(214, 177, 77);
    font-weight: 600;
  }
  
  #duration {
    color: #9ca3af;
  }
  
  .progress-container {
    position: relative;
    height: 10px;
    flex: 1;
    display: flex;
    align-items: center;
  }
  
  .progress-track {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    left: 0;
    right: 0;
    height: 5px;
    background: rgba(214, 177, 77, 0.15);
    border-radius: 2.5px;
  }
  
  .progress-fill {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    left: 0;
    height: 5px;
    background: rgb(214, 177, 77);
    border-radius: 2.5px;
    width: 0%;
    transition: width 0.1s;
  }
  
  .progress-slider {
    position: absolute;
    top: 50%;
    left: 0;
    transform: translateY(-50%);
    width: 100%;
    height: 10px;
    background: transparent;
    outline: none;
    -webkit-appearance: none;
    appearance: none;
    cursor: pointer;
    z-index: 2;
  }
  
  .progress-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 12px;
    height: 12px;
    background: rgb(214, 177, 77);
    border: 2px solid #ffffff;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }

  /* Buttons */
  .nav-btn {
    width: 32px;
    height: 32px;
    padding: 6px;
    background: #ffffff;
    border: 1.5px solid rgba(214, 177, 77, 0.6);
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  
  .nav-btn svg {
    width: 15px;
    height: 15px;
    color: rgb(214, 177, 77);
  }
  
  .play-btn {
    width: 42px;
    height: 42px;
    padding: 9px;
    background: #ffffff;
    border: 2px solid rgb(214, 177, 77);
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(214, 177, 77, 0.2);
  }
  
  .play-btn svg {
    width: 20px;
    height: 20px;
    color: rgb(214, 177, 77);
  }
  
  .nav-btn:hover, .play-btn:hover {
    transform: scale(1.06);
    background: rgba(214, 177, 77, 0.08);
  }

  /* Volume */
  .mute-btn {
    padding: 5px;
    cursor: pointer;
    background: none;
    border: none;
  }
  
  .mute-btn svg {
    width: 18px;
    height: 18px;
    color: rgb(214, 177, 77);
  }
  
  .volume-slider {
    width: 120px;
    height: 5px;
    background: rgba(214, 177, 77, 0.2);
    border-radius: 2.5px;
    outline: none;
    -webkit-appearance: none;
    appearance: none;
    cursor: pointer;
  }
  
  .volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 12px;
    height: 12px;
    background: rgb(214, 177, 77);
    border-radius: 50%;
    cursor: pointer;
  }

  .hidden { display: none !important; }

  /* Responsive */
  @media (max-width: 768px) {
    .banner-title { font-size: 2rem; }
    .banner-content { padding: 28px 20px; min-height: 160px; }
    .banner-section { min-height: 160px; }
  }

  @media (max-width: 540px) {
    #musicTitle { font-size: 14px; }
    #musicArtist { font-size: 11px; }
    .nav-btn { width: 28px; height: 28px; }
    .play-btn { width: 35px; height: 35px; }
    .volume-slider { width: 100px; }
  }
</style>

<!-- ===== Banner Section ===== -->
<section class="max-w-7xl mx-auto px-4 mt-6">
  <div class="banner-section" onclick="createNetworkBurst(event, this)">
    <div class="banner-content">
      <div>
        <nav aria-label="Breadcrumb" class="banner-breadcrumbs">
          <a href="{{ '/' | relative_url }}" onclick="event.stopPropagation()">Home</a>
          <span class="sep">›</span>
          <span>Archives</span>
          <span class="sep">›</span>
          <span aria-current="page">Playlist</span>
        </nav>
        <h1 class="banner-title">Playlist</h1>
      </div>
    </div>
  </div>
</section>

<!-- ===== Collapsible Playlist Section ===== -->
<div class="playlist-container">
  <div class="collapsible-section" id="ischoi-section">
    <div class="collapsible-header" id="toggleHeader">
      <h2 class="collapsible-title"><span class="name-highlight">Insu Choi</span>'s Playlist</h2>
      <svg class="collapse-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
      </svg>
    </div>
    <div class="collapsible-content">
      <div class="content-inner">
        <!-- Music Player -->
        <div id="musicPlayer" class="fade-in">
          <div class="music-player-box" role="group" aria-label="배경 음악 플레이어">

            <!-- 줄1: 제목 -->
            <div class="player-row title-row">
              <span id="musicTitle">Loading...</span>
            </div>

            <!-- 줄2: 아티스트 -->
            <div class="player-row artist-row">
              <span id="musicArtist"></span>
            </div>

            <!-- 줄3: 재생버튼 -->
            <div class="player-row playback-row">
              <button id="prevBtn" class="nav-btn" type="button" aria-label="이전 곡">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M8.445 14.832A1 1 0 0010 14v-2.798l5.445 3.63A1 1 0 0017 14V6a1 1 0 00-1.555-.832L10 8.798V6a1 1 0 00-1.555-.832l-6 4a1 1 0 000 1.664l6 4z"/>
                </svg>
              </button>
              <button id="playPauseBtn" class="play-btn" type="button" aria-label="재생/일시정지">
                <svg id="playIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/>
                </svg>
                <svg id="pauseIcon" class="hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
              </button>
              <button id="nextBtn" class="nav-btn" type="button" aria-label="다음 곡">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M4.555 5.168A1 1 0 003 6v8a1 1 0 001.555.832L10 11.202V14a1 1 0 001.555.832l6-4a1 1 0 000-1.664l-6-4A1 1 0 0010 6v2.798L4.555 5.168z"/>
                </svg>
              </button>
            </div>

            <!-- 줄4: 볼륨 -->
            <div class="player-row volume-row">
              <button id="muteBtn" class="mute-btn" type="button" aria-label="음소거">
                <svg id="volumeIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z" clip-rule="evenodd"/>
                </svg>
                <svg id="muteIcon" class="hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM12.293 7.293a1 1 0 011.414 0L15 8.586l1.293-1.293a1 1 0 111.414 1.414L16.414 10l1.293 1.293a1 1 0 01-1.414 1.414L15 11.414l-1.293 1.293a1 1 0 01-1.414-1.414L13.586 10l-1.293-1.293a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
              </button>
              <input type="range" id="volumeSlider" min="0" max="100" value="30" class="volume-slider" aria-label="볼륨">
            </div>

            <!-- 줄5: 진행바/시간 -->
            <div class="player-row progress-row">
              <span id="currentTime" class="time-text">0:00</span>
              <div class="progress-container">
                <div class="progress-track"></div>
                <div id="progressBar" class="progress-fill"></div>
                <input type="range" id="progressSlider" min="0" max="100" value="0" step="0.1" class="progress-slider" aria-label="재생 위치">
              </div>
              <span id="duration" class="time-text">0:00</span>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- YouTube IFrame API용 (숨김) -->
<div id="youtube-player" style="display:none;"></div>

<!-- ===== Scripts ===== -->
<script>
// ===================== 전역 상태 =====================
var YOUTUBE_CONFIG = { shuffle: true };
var tracks = [];
var shuffledOrder = [];
var orderPos = 0;
var currentVideoIndex = 0;
var player;
var isPlayerReady = false;
var updateTimer = null;
var isDragging = false;
var playlistLoadError = false;

// ===================== 유틸 함수 =====================
function extractVideoId(url) {
  if (!url) return null;
  if (/^[a-zA-Z0-9_-]{11}$/.test(url)) return url;
  var videoId = null;
  if (url.includes('music.youtube.com')) {
    var match = url.match(/[?&]v=([a-zA-Z0-9_-]{11})/);
    if (match) videoId = match[1];
  } else if (url.indexOf('v=') > -1) {
    var vParam = url.split('v=')[1];
    if (vParam) videoId = vParam.split(/[&#]/)[0];
  } else if (url.indexOf('youtu.be/') > -1) {
    videoId = url.split('youtu.be/')[1].split(/[?#&]/)[0];
  } else if (url.indexOf('/embed/') > -1) {
    videoId = url.split('/embed/')[1].split(/[?#&]/)[0];
  }
  return (videoId && /^[a-zA-Z0-9_-]{11}$/.test(videoId)) ? videoId : null;
}

function toNumberOrNull(v) {
  var n = parseFloat(v);
  return Number.isFinite(n) ? n : null;
}

// ===================== Playlist 로드 =====================
function loadPlaylistJson() {
  console.log('Starting to load playlist...');
  
  // 기본 경로 설정
  var baseUrl = window.location.origin;
  var pathname = window.location.pathname;
  var basePath = pathname.substring(0, pathname.lastIndexOf('/') + 1);
  
  // 시도할 경로들
  var paths = [
    basePath + 'playlist/ischoi.json',
    baseUrl + '/playlist/ischoi.json',
    './playlist/ischoi.json',
    '/playlist/ischoi.json'
  ];
  
  console.log('Will try these paths:', paths);
  
  var tryLoad = function(index) {
    if (index >= paths.length) {
      console.error('Failed to load playlist from all paths');
      handlePlaylistError();
      return;
    }
    
    var url = paths[index];
    console.log('Attempting to load:', url);
    
    fetch(url)
      .then(function(response) {
        console.log('Response status:', response.status);
        if (!response.ok) {
          throw new Error('HTTP ' + response.status);
        }
        return response.json();
      })
      .then(function(data) {
        console.log('Successfully loaded data:', data);
        if (data && data.items && Array.isArray(data.items)) {
          buildFromJson(data);
        } else {
          console.error('Invalid data structure');
          tryLoad(index + 1);
        }
      })
      .catch(function(error) {
        console.error('Failed to load from', url, ':', error);
        tryLoad(index + 1);
      });
  };
  
  tryLoad(0);
}

function buildFromJson(json) {
  tracks = [];
  YOUTUBE_CONFIG.shuffle = (typeof json.shuffle === 'boolean') ? json.shuffle : true;
  
  if (!json.items || !Array.isArray(json.items)) {
    console.error('No items array found');
    handlePlaylistError();
    return;
  }
  
  console.log('Processing', json.items.length, 'items');
  
  json.items.forEach(function(item, index) {
    if (item.enabled === false) return;
    
    var id = item.id || extractVideoId(item.url);
    if (!id) {
      console.warn('No valid ID for item', index, item);
      return;
    }
    
    tracks.push({
      id: id,
      url: item.url || null,
      weight: Math.max(1, parseInt(item.weight || 1, 10)),
      start_at: toNumberOrNull(item.start_at),
      end_at: toNumberOrNull(item.end_at),
      title_override: item.title_override || null
    });
  });
  
  console.log('Loaded', tracks.length, 'tracks');
  
  if (tracks.length === 0) {
    console.error('No valid tracks found');
    handlePlaylistError();
    return;
  }
  
  generateShuffleOrder();
  injectYouTubeAPI();
}

function generateShuffleOrder() {
  // 첫 번째 곡은 항상 고정
  shuffledOrder = [0];
  
  // 나머지 곡들만 셔플 (중복 없이)
  var remainingIndices = [];
  for (var i = 1; i < tracks.length; i++) {
    remainingIndices.push(i);
  }
  
  // Fisher-Yates 셔플
  for (var i = remainingIndices.length - 1; i > 0; i--) {
    var j = Math.floor(Math.random() * (i + 1));
    var tmp = remainingIndices[i];
    remainingIndices[i] = remainingIndices[j];
    remainingIndices[j] = tmp;
  }
  
  shuffledOrder = shuffledOrder.concat(remainingIndices);
  orderPos = 0;
  currentVideoIndex = 0;
  
  console.log('Shuffle order generated:', shuffledOrder);
}

function handlePlaylistError() {
  playlistLoadError = true;
  var titleEl = document.getElementById('musicTitle');
  var artistEl = document.getElementById('musicArtist');
  
  if (titleEl) titleEl.textContent = 'Playlist 로드 실패';
  if (artistEl) artistEl.textContent = '';
  
  var playBtn = document.getElementById('playPauseBtn');
  var prevBtn = document.getElementById('prevBtn');
  var nextBtn = document.getElementById('nextBtn');
  if (playBtn) playBtn.disabled = true;
  if (prevBtn) prevBtn.disabled = true;
  if (nextBtn) nextBtn.disabled = true;
}

// ===================== YouTube API =====================
function injectYouTubeAPI() {
  if (playlistLoadError) return;
  var tag = document.createElement('script');
  tag.src = "https://www.youtube.com/iframe_api";
  var first = document.getElementsByTagName('script')[0];
  first.parentNode.insertBefore(tag, first);
}

function onYouTubeIframeAPIReady() {
  if (!tracks.length) {
    handlePlaylistError();
    return;
  }
  
  player = new YT.Player('youtube-player', {
    height: '0',
    width: '0',
    videoId: tracks[currentVideoIndex].id,
    playerVars: {
      'autoplay': 0,
      'controls': 0,
      'disablekb': 1,
      'fs': 0,
      'modestbranding': 1,
      'rel': 0
    },
    events: {
      'onReady': onPlayerReady,
      'onStateChange': onPlayerStateChange,
      'onError': onPlayerError
    }
  });
}
window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;

function onPlayerReady(event) {
  isPlayerReady = true;
  event.target.setVolume(30);
  event.target.mute();
  resetProgress();
  
  var t = tracks[currentVideoIndex];
  if (t && t.start_at !== null && t.start_at > 0) {
    try {
      event.target.seekTo(t.start_at, true);
    } catch(e) {}
  }
}

function onPlayerStateChange(event) {
  var musicPlayer = document.getElementById('musicPlayer');
  var playIcon = document.getElementById('playIcon');
  var pauseIcon = document.getElementById('pauseIcon');
  
  if (event.data == YT.PlayerState.PLAYING) {
    playIcon.classList.add('hidden');
    pauseIcon.classList.remove('hidden');
    updateVideoTitle();
    startProgressUpdate();
  } else if (event.data == YT.PlayerState.PAUSED) {
    playIcon.classList.remove('hidden');
    pauseIcon.classList.add('hidden');
    stopProgressUpdate();
  } else if (event.data == YT.PlayerState.ENDED) {
    playIcon.classList.remove('hidden');
    pauseIcon.classList.add('hidden');
    stopProgressUpdate();
    loadNextVideo();
  } else if (event.data == YT.PlayerState.CUED) {
    resetProgress();
  }
}

function onPlayerError(event) {
  console.error('Player error:', event);
  var titleElement = document.getElementById('musicTitle');
  if (tracks.length > 1) {
    titleElement.textContent = '오류 발생, 다음 곡 재생 중...';
    setTimeout(loadNextVideo, 1200);
  } else {
    titleElement.textContent = '재생 오류가 발생했습니다.';
  }
}

// ===================== 재생 제어 =====================
function gotoByStep(step) {
  if (tracks.length <= 1) return;
  
  orderPos = orderPos + step;
  
  // 끝에 도달하면 다시 셔플
  if (orderPos >= shuffledOrder.length) {
    console.log('Playlist ended, reshuffling...');
    generateShuffleOrder();
    orderPos = 0;
  } else if (orderPos < 0) {
    orderPos = shuffledOrder.length - 1;
  }
  
  currentVideoIndex = shuffledOrder[orderPos];
  console.log('Now playing track', currentVideoIndex + 1, 'of', tracks.length);
}

function loadNextVideo() {
  gotoByStep(1);
  resetProgress();
  player.loadVideoById(tracks[currentVideoIndex].id);
  
  var t = tracks[currentVideoIndex];
  if (t && t.start_at !== null && t.start_at > 0) {
    setTimeout(function() {
      try {
        player.seekTo(t.start_at, true);
      } catch(e) {}
    }, 250);
  }
}

function loadPreviousVideo() {
  gotoByStep(-1);
  resetProgress();
  player.loadVideoById(tracks[currentVideoIndex].id);
  
  var t = tracks[currentVideoIndex];
  if (t && t.start_at !== null && t.start_at > 0) {
    setTimeout(function() {
      try {
        player.seekTo(t.start_at, true);
      } catch(e) {}
    }, 250);
  }
}

// ===================== 제목 처리 =====================
function sanitize(s) {
  return String(s || '').replace(/[\r\n]+/g,' ').replace(/\s+/g,' ').trim();
}

function stripDecorations(title) {
  return sanitize(title)
    .replace(/\s*\([^)]*\)\s*$/g,'')
    .replace(/\s*\[.*?\]\s*$/g,'')
    .replace(/\s*(Official\s*(Video|Audio|MV))\s*$/i,'')
    .replace(/\s*-\s*Topic\s*$/i,'');
}

function splitTitleArtist(cleanTitle, cleanAuthor) {
  // 제목에서 ' - '로 분리
  const parts = cleanTitle.split(' - ').map(sanitize);
  
  // 작가/아티스트 처리 - Topic 제거
  let artist = sanitize(cleanAuthor).replace(/\s*-\s*Topic\s*$/i,'');
  
  // 제목이 "아티스트 - 노래제목" 형식인 경우
  if (parts.length >= 2) {
    const leftPart = parts[0];
    const rightPart = parts.slice(1).join(' - ');
    
    // 왼쪽 부분이 아티스트일 가능성이 높음
    // 쉼표가 있으면 여러 아티스트
    if (leftPart.includes(',') || leftPart.includes('&') || leftPart.includes('feat')) {
      artist = leftPart;  // 전체 아티스트 이름 사용
    } else {
      artist = leftPart;
    }
    
    return { song: rightPart, artist: artist };
  }
  
  // 제목에 ' - '가 없는 경우, YouTube author를 그대로 사용
  // 쉼표로 구분된 여러 아티스트도 그대로 표시
  return { song: cleanTitle, artist: artist };
}

function updateVideoTitle() {
  if (!isPlayerReady || !player) return;
  
  try {
    var videoData = player.getVideoData();
    var songEl = document.getElementById('musicTitle');
    var artistEl = document.getElementById('musicArtist');
    
    if (!videoData || !videoData.title) return;
    
    var cleanTitle = stripDecorations(videoData.title || '');
    var cleanAuthor = stripDecorations(videoData.author || '');
    
    var t = tracks[currentVideoIndex];
    if (t && t.title_override) {
      cleanTitle = stripDecorations(t.title_override);
    }
    
    var msg = splitTitleArtist(cleanTitle, cleanAuthor);
    
    if (artistEl) artistEl.textContent = msg.artist || '';
    if (songEl) songEl.textContent = msg.song || 'Background Music';
    
  } catch (e) {
    console.error('Error updating title:', e);
  }
}

// ===================== 진행바 =====================
function formatTime(seconds) {
  if (!seconds || isNaN(seconds)) return '0:00';
  var mins = Math.floor(seconds / 60);
  var secs = Math.floor(seconds % 60);
  return mins + ':' + (secs < 10 ? '0' : '') + secs;
}

function updateProgress() {
  if (!isPlayerReady || !player || isDragging) return;
  try {
    var currentTime = player.getCurrentTime();
    var duration = player.getDuration();
    if (duration > 0) {
      var percentage = (currentTime / duration) * 100;
      document.getElementById('progressSlider').value = percentage;
      document.getElementById('progressBar').style.width = percentage + '%';
      document.getElementById('currentTime').textContent = formatTime(currentTime);
      document.getElementById('duration').textContent = formatTime(duration);
    }
  } catch (e) {}
}

function startProgressUpdate() {
  if (!updateTimer) {
    updateTimer = setInterval(updateProgress, 500);
    updateProgress();
  }
}

function stopProgressUpdate() {
  if (updateTimer) {
    clearInterval(updateTimer);
    updateTimer = null;
  }
}

function resetProgress() {
  document.getElementById('progressSlider').value = 0;
  document.getElementById('progressBar').style.width = '0%';
  document.getElementById('currentTime').textContent = '0:00';
  document.getElementById('duration').textContent = '0:00';
}

// ===================== Banner Effect =====================
function createNetworkBurst(event, element) {
  const rect = element.getBoundingClientRect();
  const x = event.clientX - rect.left - 100;
  const y = event.clientY - rect.top - 100;

  const networkDiv = document.createElement('div');
  networkDiv.className = 'network-burst';
  networkDiv.style.left = x + 'px';
  networkDiv.style.top = y + 'px';

  const svg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200">' +
    '<circle cx="100" cy="100" r="50" fill="none" class="burst-line"/>' +
    '<circle cx="100" cy="100" r="5" class="burst-dot"/>' +
    '</svg>';
  networkDiv.innerHTML = svg;

  element.appendChild(networkDiv);
  setTimeout(() => element.removeChild(networkDiv), 2000);
}

// ===================== DOM 초기화 =====================
document.addEventListener('DOMContentLoaded', function() {
  // 토글 기능
  var toggleHeader = document.getElementById('toggleHeader');
  var section = document.getElementById('ischoi-section');
  
  if (toggleHeader && section) {
    toggleHeader.addEventListener('click', function() {
      section.classList.toggle('open');
    });
  }
  
  // 초기값 설정
  document.getElementById('progressSlider').value = 0;
  document.getElementById('volumeSlider').value = 30;
  
  // Playlist 로드
  loadPlaylistJson();
  
  // 플레이어 컨트롤
  document.getElementById('playPauseBtn').addEventListener('click', function() {
    if (playlistLoadError || !isPlayerReady || !player) return;
    var state = player.getPlayerState();
    if (state == YT.PlayerState.PLAYING) {
      player.pauseVideo();
    } else {
      updateVideoTitle();
      player.playVideo();
      if (player.isMuted()) {
        player.unMute();
        document.getElementById('volumeIcon').classList.remove('hidden');
        document.getElementById('muteIcon').classList.add('hidden');
      }
    }
  });
  
  document.getElementById('prevBtn').addEventListener('click', function() {
    if (playlistLoadError || !isPlayerReady || !player || tracks.length <= 1) return;
    loadPreviousVideo();
    setTimeout(updateVideoTitle, 500);
  });
  
  document.getElementById('nextBtn').addEventListener('click', function() {
    if (playlistLoadError || !isPlayerReady || !player || tracks.length <= 1) return;
    loadNextVideo();
    setTimeout(updateVideoTitle, 500);
  });
  
  document.getElementById('muteBtn').addEventListener('click', function() {
    if (!isPlayerReady || !player) return;
    if (player.isMuted()) {
      player.unMute();
      document.getElementById('volumeIcon').classList.remove('hidden');
      document.getElementById('muteIcon').classList.add('hidden');
      document.getElementById('volumeSlider').value = player.getVolume();
    } else {
      player.mute();
      document.getElementById('volumeIcon').classList.add('hidden');
      document.getElementById('muteIcon').classList.remove('hidden');
    }
  });
  
  document.getElementById('volumeSlider').addEventListener('input', function() {
    if (!isPlayerReady || !player) return;
    player.setVolume(this.value);
    if (this.value == 0) {
      player.mute();
      document.getElementById('volumeIcon').classList.add('hidden');
      document.getElementById('muteIcon').classList.remove('hidden');
    } else if (player.isMuted()) {
      player.unMute();
      document.getElementById('volumeIcon').classList.remove('hidden');
      document.getElementById('muteIcon').classList.add('hidden');
    }
  });
  
  // 진행바 드래그
  var progressSlider = document.getElementById('progressSlider');
  
  progressSlider.addEventListener('mousedown', function() { isDragging = true; });
  progressSlider.addEventListener('mouseup', function() { isDragging = false; });
  progressSlider.addEventListener('touchstart', function() { isDragging = true; });
  progressSlider.addEventListener('touchend', function() { isDragging = false; });
  
  progressSlider.addEventListener('input', function() {
    document.getElementById('progressBar').style.width = this.value + '%';
    if (isPlayerReady && player) {
      var duration = player.getDuration();
      if (duration > 0) {
        var seekTime = (this.value / 100) * duration;
        document.getElementById('currentTime').textContent = formatTime(seekTime);
      }
    }
  });
  
  progressSlider.addEventListener('change', function() {
    if (!isPlayerReady || !player) {
      isDragging = false;
      return;
    }
    var duration = player.getDuration();
    if (duration > 0) {
      var seekTime = (this.value / 100) * duration;
      player.seekTo(seekTime, true);
    }
    setTimeout(function() { isDragging = false; }, 100);
  });
});
</script>
